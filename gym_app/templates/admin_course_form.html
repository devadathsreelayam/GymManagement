{% extends 'base.html' %}

{% block title %}{% if course %}Edit{% else %}Add{% endif %} Course - FitPro Gym{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h4 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-{% if course %}edit{% else %}plus{% endif %} me-2"></i>
                        {% if course %}Edit Course{% else %}Add New Course{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}

                        <div class="row">
                            <!-- Course Name -->
                            <div class="col-md-8 mb-3">
                                <label for="name" class="form-label">Course Name *</label>
                                <input type="text"
                                       class="form-control"
                                       id="name"
                                       name="name"
                                       value="{{ course.name|default:'' }}"
                                       required
                                       placeholder="Enter course name">
                                <div class="form-text">The name of the course as it will appear to members.</div>
                            </div>

                            <!-- Price -->
                            <div class="col-md-4 mb-3">
                                <label for="price" class="form-label">Price (â‚¹) *</label>
                                <input type="number"
                                       class="form-control"
                                       id="price"
                                       name="price"
                                       value="{{ course.price|default:'' }}"
                                       required
                                       min="0"
                                       step="0.01"
                                       placeholder="0.00">
                                <div class="form-text">Course enrollment fee in Indian Rupees.</div>
                            </div>

                            <!-- Description -->
                            <div class="col-12 mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control"
                                          id="description"
                                          name="description"
                                          rows="4"
                                          placeholder="Enter course description, benefits, target audience, etc.">{{ course.description|default:'' }}</textarea>
                                <div class="form-text">Detailed description about the course content and benefits.</div>
                            </div>

                            <!-- Trainer -->
                            <div class="col-md-6 mb-3">
                                <label for="trainer" class="form-label">Trainer *</label>
                                <select class="form-select" id="trainer" name="trainer" required>
                                    <option value="">Select Trainer</option>
                                    {% for trainer in trainers %}
                                    <option value="{{ trainer.id }}"
                                            {% if course.trainer.id == trainer.id %}selected{% endif %}>
                                        {{ trainer.name }} - {{ trainer.specialization }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select the trainer who will conduct this course.</div>
                            </div>

                            <!-- Difficulty Level -->
                            <div class="col-md-6 mb-3">
                                <label for="difficulty_level" class="form-label">Difficulty Level</label>
                                <select class="form-select" id="difficulty_level" name="difficulty_level">
                                    {% for diff_code, diff_name in difficulties %}
                                    <option value="{{ diff_code }}"
                                            {% if course.difficulty_level == diff_code %}selected{% endif %}>
                                        {{ diff_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Target difficulty level for this course.</div>
                            </div>

                            <!-- Capacity -->
                            <div class="col-md-4 mb-3">
                                <label for="capacity" class="form-label">Capacity</label>
                                <input type="number"
                                       class="form-control"
                                       id="capacity"
                                       name="capacity"
                                       value="{{ course.capacity|default:20 }}"
                                       min="1"
                                       max="100"
                                       placeholder="20">
                                <div class="form-text">Maximum number of students allowed in this course.</div>
                            </div>

                            <!-- Duration -->
                            <div class="col-md-4 mb-3">
                                <label for="duration_minutes" class="form-label">Duration (minutes)</label>
                                <input type="number"
                                       class="form-control"
                                       id="duration_minutes"
                                       name="duration_minutes"
                                       value="{{ course.duration_minutes|default:60 }}"
                                       min="15"
                                       max="180"
                                       step="15"
                                       placeholder="60">
                                <div class="form-text">Duration of each session in minutes.</div>
                            </div>

                            <!-- Status -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Status</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="is_active"
                                           name="is_active"
                                           {% if course.is_active or not course %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">
                                        Active Course
                                    </label>
                                </div>
                                <div class="form-text">Inactive courses won't be available for new enrollments.</div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2 justify-content-end">
                                    <a href="{% url 'admin_course_management' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>
                                        {% if course %}Update Course{% else %}Create Course{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Current Information (for edit mode) -->
            {% if course %}
            <div class="row mt-4">
                <!-- Enrollment Stats -->
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header py-3 bg-info text-white">
                            <h6 class="m-0 font-weight-bold">
                                <i class="fas fa-users me-2"></i>Enrollment Statistics
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 class="text-primary">{{ course.current_enrollment }}</h4>
                                    <small class="text-muted">Total Enrollments</small>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-success">
                                        {% with active_enrollments=course.enrollments.filter.is_active %}
                                        {{ active_enrollments }}
                                        {% endwith %}
                                    </h4>
                                    <small class="text-muted">Active Enrollments</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                {% widthratio course.current_enrollment course.capacity 100 as enrollment_percentage %}
                                <div class="progress-bar
                                    {% if enrollment_percentage >= 90 %}bg-danger
                                    {% elif enrollment_percentage >= 70 %}bg-warning
                                    {% else %}bg-success{% endif %}"
                                    style="width: {{ enrollment_percentage }}%">
                                    {{ enrollment_percentage|floatformat:0 }}%
                                </div>
                            </div>
                            <small class="text-muted">{{ course.current_enrollment }} of {{ course.capacity }} spots filled</small>
                        </div>
                    </div>
                </div>

                <!-- Session Info -->
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header py-3 bg-primary text-white">
                            <h6 class="m-0 font-weight-bold">
                                <i class="fas fa-calendar me-2"></i>Session Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center">
                                <h4 class="text-primary">{{ course.sessions.count }}</h4>
                                <small class="text-muted">Weekly Sessions</small>
                            </div>
                            {% if course.sessions.exists %}
                            <div class="mt-3">
                                <small class="text-muted">Current Schedule:</small>
                                <ul class="list-unstyled mb-0">
                                    {% for session in course.sessions.all|slice:":3" %}
                                    <li><small>{{ session.day_of_week }}: {{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}</small></li>
                                    {% endfor %}
                                    {% if course.sessions.count > 3 %}
                                    <li><small class="text-muted">+{{ course.sessions.count|add:"-3" }} more sessions</small></li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                            <div class="text-center mt-3">
                                <a href="{% url 'admin_manage_sessions' course.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-calendar-plus me-1"></i>Manage Sessions
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
    border: none;
}

.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.progress {
    background-color: #eaecf4;
    border-radius: 4px;
    height: 25px;
}

.progress-bar {
    border-radius: 4px;
    font-weight: 600;
}
</style>

<script>
// Real-time price formatting
document.getElementById('price').addEventListener('input', function(e) {
    let value = parseFloat(e.target.value);
    if (!isNaN(value) && value >= 0) {
        e.target.value = value.toFixed(2);
    }
});

// Capacity validation
document.getElementById('capacity').addEventListener('input', function(e) {
    let value = parseInt(e.target.value);
    if (value < 1) {
        e.target.value = 1;
    } else if (value > 100) {
        e.target.value = 100;
    }
});
</script>
{% endblock %}